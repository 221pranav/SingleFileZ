!function(){"use strict";const e=33554432,t=globalThis.singlefileBootstrap,o=new Map;let n,a,s,r,d,i,c,u,l,m,h,v;async function f(){if(void 0!==document.documentElement.dataset.sfz){!function(e){const t=document.createElement("script");t.textContent="(() => { document.currentScript.remove(); const bootstrapReady = this.bootstrap && this.bootstrap(["+new Uint8Array(e).toString()+']); if (bootstrapReady) { bootstrapReady.then(() => document.dispatchEvent(new CustomEvent("single-filez-display-infobar"))); } })()',document.body.appendChild(t)}(await p())}else if(document.body&&1==document.body.childNodes.length&&"PRE"==document.body.childNodes[0].tagName&&/<html[^>]* data-sfz[^>]*>/i.test(document.body.childNodes[0].textContent)){const e=(new DOMParser).parseFromString(document.body.childNodes[0].textContent,"text/html");document.replaceChild(e.documentElement,document.documentElement),document.querySelectorAll("script").forEach((e=>{const t=document.createElement("script");t.textContent=e.textContent,e.parentElement.replaceChild(t,e)})),await f()}}function p(){return new Promise(((e,t)=>{const n=new XMLHttpRequest;n.open("GET",location.href),n.send(),n.responseType="arraybuffer",n.onload=()=>e(new Uint8Array(n.response)),n.onerror=()=>{const n=document.getElementById("sfz-error-message");n&&n.remove();const a=o.size;o.set(a,{resolve:e,reject:t}),browser.runtime.sendMessage({method:"singlefile.fetch",requestId:a,url:location.href})}}))}async function y(e){return d&&"content.autosave"==e.method?(async function(e){a=e.options,"complete"!=document.readyState&&await new Promise((e=>globalThis.addEventListener("load",e)));await g(),a.autoSaveRepeat&&setTimeout((()=>{d&&!c&&(u=!1,a.autoSaveDelay=0,y(e))}),1e3*a.autoSaveRepeatDelay)}(e),{}):"content.maybeInit"==e.method?(E(),{}):"content.init"==e.method?(a=e.options,d=e.autoSaveEnabled,S(),{}):"content.openEditor"==e.method?(I(document)?D():S(),{}):"devtools.resourceCommitted"==e.method?(t.pageInfo.updatedResources[e.url]={content:e.content,type:e.type,encoding:e.encoding},{}):void("singlefile.fetchResponse"==e.method&&async function(e){const t=o.get(e.requestId);if(t)e.error?(t.reject(new Error(e.error)),o.delete(e.requestId)):(e.truncated&&(t.array?t.array=t.array.concat(e.array):(t.array=e.array,o.set(e.requestId,t)),e.finished&&(e.array=t.array)),e.truncated&&!e.finished||(t.resolve(e.array),o.delete(e.requestId)))}(e))}function E(){const e=document.querySelector("singlefile-infobar");e&&e.remove(),l==location.href||t.pageInfo.processing||(u=!1,l=location.href,browser.runtime.sendMessage({method:"tabs.init",savedPageDetected:I(document)}).catch((()=>{})),browser.runtime.sendMessage({method:"ui.processInit"}).catch((()=>{})))}async function g(){const e=t.helper;if((!c||i)&&!u)if(c=!0,a.autoSaveDelay&&!i)await new Promise((e=>i=setTimeout(e,1e3*a.autoSaveDelay))),await g();else{const o=window[e.WAIT_FOR_USERSCRIPT_PROPERTY_NAME];let n,s=[];i=null,!a.removeFrames&&globalThis.frames&&globalThis.frames.length&&(s=await t.processors.frameTree.getAsync(a)),n=s&&s.sessionId,a.userScriptEnabled&&o&&await o(e.ON_BEFORE_CAPTURE_EVENT_NAME);const r=e.preProcessDoc(document,globalThis,a);w(r,s),n&&t.processors.frameTree.cleanup(n),e.postProcessDoc(document,r.markedElements,r.invalidElements),a.userScriptEnabled&&o&&await o(e.ON_AFTER_CAPTURE_EVENT_NAME),u=!0,c=!1}}function S(){d&&a&&(a.autoSaveUnload||a.autoSaveLoadOrUnload||a.autoSaveDiscard||a.autoSaveRemove)?n||(globalThis.addEventListener("unload",R),document.addEventListener("visibilitychange",b),n=!0):(globalThis.removeEventListener("unload",R),document.removeEventListener("visibilitychange",b),n=!1)}function b(){"hidden"==document.visibilityState&&a.autoSaveDiscard&&T({autoSaveDiscard:a.autoSaveDiscard})}function R(){!u&&(a.autoSaveUnload||a.autoSaveLoadOrUnload||a.autoSaveRemove)&&T({autoSaveUnload:a.autoSaveUnload,autoSaveRemove:a.autoSaveRemove})}function T({autoSaveUnload:e,autoSaveDiscard:o,autoSaveRemove:n}){const s=t.helper,r=window[s.WAIT_FOR_USERSCRIPT_PROPERTY_NAME];let d=[];!a.removeFrames&&globalThis.frames&&globalThis.frames.length&&(d=t.processors.frameTree.getSync(a)),a.userScriptEnabled&&r&&r(s.ON_BEFORE_CAPTURE_EVENT_NAME);w(s.preProcessDoc(document,globalThis,a),d,{autoSaveUnload:e,autoSaveDiscard:o,autoSaveRemove:n})}function w(e,o,{autoSaveUnload:n,autoSaveDiscard:d,autoSaveRemove:i}={}){const c=t.helper,u=t.pageInfo.updatedResources,l=t.pageInfo.visitDate.getTime();Object.keys(u).forEach((e=>u[e].retrieved=!1)),browser.runtime.sendMessage({method:"autosave.save",tabId:s,tabIndex:r,taskId:a.taskId,content:c.serialize(document),canvases:e.canvases,fonts:e.fonts,stylesheets:e.stylesheets,images:e.images,posters:e.posters,usedFonts:e.usedFonts,shadowRoots:e.shadowRoots,videos:e.videos,referrer:e.referrer,adoptedStyleSheets:e.adoptedStyleSheets,frames:o,url:location.href,updatedResources:u,visitDate:l,autoSaveUnload:n,autoSaveDiscard:d,autoSaveRemove:i})}async function D(){const t=await p();for(let o=0;o*e<t.length;o++){const n={method:"editor.open",filename:decodeURIComponent(location.href.match(/^.*\/(.*)$/)[1]),extractDataFromPageTags:h,insertTextBody:v,selfExtractingArchive:!0};n.truncated=t.length>e,n.truncated?(n.finished=(o+1)*e>t.length,t instanceof Uint8Array?n.content=Array.from(t.subarray(o*e,(o+1)*e)):n.content=t.substring(o*e,(o+1)*e)):n.content=t instanceof Uint8Array?Array.from(t):t,await browser.runtime.sendMessage(n)}}function I(e){if(void 0===m){const o=t.helper,n=e.documentElement.firstChild;h=Boolean(e.querySelector("sfz-extra-data")),v=Boolean(e.querySelector("body > main[hidden]")),m=""==e.documentElement.dataset.sfz||n.nodeType==Node.COMMENT_NODE&&n.textContent.includes(o.COMMENT_HEADER)}return m}t.pageInfo={updatedResources:{},visitDate:new Date},browser.runtime.sendMessage({method:"bootstrap.init"}).then((e=>{a=e.optionsAutoSave;const t=e.options;s=e.tabId,r=e.tabIndex,d=e.autoSaveEnabled,t&&t.autoOpenEditor&&I(document)?"loading"==document.readyState?document.addEventListener("DOMContentLoaded",(()=>D())):D():"loading"==document.readyState?document.addEventListener("DOMContentLoaded",S):S()})),browser.runtime.onMessage.addListener((e=>{if(d&&"content.autosave"==e.method||"content.maybeInit"==e.method||"content.init"==e.method||"content.openEditor"==e.method||"devtools.resourceCommitted"==e.method||"singlefile.fetchResponse"==e.method)return y(e)})),document.addEventListener("DOMContentLoaded",E,!1),globalThis.window==globalThis.top&&location&&location.href&&(location.href.startsWith("file://")||location.href.startsWith("content://"))&&("loading"==document.readyState?document.addEventListener("DOMContentLoaded",f,!1):f())}();
