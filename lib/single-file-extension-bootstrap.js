!function(){"use strict";const e=33554432,t=globalThis.singlefileBootstrap,o=new Map;let n,a,r,s,d,i,c,l,u,m,h,f;async function v(){if(void 0!==document.documentElement.dataset.sfz){const e=await g();document.querySelectorAll("#sfz-error-message").forEach((e=>e.remove())),function(e){const t=document.createElement("script");t.textContent="(()=>{document.currentScript.remove();if(document.readyState=='complete')run();else globalThis.addEventListener('load', run);function run(){this.bootstrap(["+new Uint8Array(e).toString()+']).then(()=>document.dispatchEvent(new CustomEvent("single-filez-display-infobar")))}})()',document.body.appendChild(t)}(e)}else if(document.body&&1==document.body.childNodes.length&&"PRE"==document.body.childNodes[0].tagName&&/<html[^>]* data-sfz[^>]*>/i.test(document.body.childNodes[0].textContent)){const e=(new DOMParser).parseFromString(document.body.childNodes[0].textContent,"text/html");document.replaceChild(e.documentElement,document.documentElement),document.querySelectorAll("script").forEach((e=>{const t=document.createElement("script");t.textContent=e.textContent,e.parentElement.replaceChild(t,e)})),await v()}}function g(){return new Promise(((e,t)=>{const n=new XMLHttpRequest;n.open("GET",location.href),n.send(),n.responseType="arraybuffer",n.onload=()=>e(new Uint8Array(n.response)),n.onerror=()=>{const n=document.getElementById("sfz-error-message");n&&n.remove();const a=o.size;o.set(a,{resolve:e,reject:t}),browser.runtime.sendMessage({method:"singlefile.fetch",requestId:a,url:location.href})}}))}async function p(e){return d&&"content.autosave"==e.method?(async function(e){a=e.options,"complete"!=document.readyState&&await new Promise((e=>globalThis.addEventListener("load",e)));await E(),a.autoSaveRepeat&&setTimeout((()=>{d&&!c&&(l=!1,a.autoSaveDelay=0,p(e))}),1e3*a.autoSaveRepeatDelay)}(e),{}):"content.maybeInit"==e.method?(y(),{}):"content.init"==e.method?(a=e.options,d=e.autoSaveEnabled,S(),{}):"content.openEditor"==e.method?(C(document)?I():S(),{}):"devtools.resourceCommitted"==e.method?(t.pageInfo.updatedResources[e.url]={content:e.content,type:e.type,encoding:e.encoding},{}):void("singlefile.fetchResponse"==e.method&&async function(e){const t=o.get(e.requestId);if(t)e.error?(t.reject(new Error(e.error)),o.delete(e.requestId)):(e.truncated&&(t.array?t.array=t.array.concat(e.array):(t.array=e.array,o.set(e.requestId,t)),e.finished&&(e.array=t.array)),e.truncated&&!e.finished||(t.resolve(e.array),o.delete(e.requestId)))}(e))}function y(){const e=document.querySelector("singlefile-infobar");e&&e.remove(),u==location.href||t.pageInfo.processing||(l=!1,u=location.href,browser.runtime.sendMessage({method:"tabs.init",savedPageDetected:C(document)}).catch((()=>{})),browser.runtime.sendMessage({method:"ui.processInit"}).catch((()=>{})))}async function E(){const e=t.helper;if((!c||i)&&!l)if(c=!0,a.autoSaveDelay&&!i)await new Promise((e=>i=setTimeout(e,1e3*a.autoSaveDelay))),await E();else{const o=globalThis[e.WAIT_FOR_USERSCRIPT_PROPERTY_NAME];let n,r=[];i=null,!a.removeFrames&&globalThis.frames&&globalThis.frames.length&&(r=await t.processors.frameTree.getAsync(a)),n=r&&r.sessionId,a.userScriptEnabled&&o&&await o(e.ON_BEFORE_CAPTURE_EVENT_NAME);const s=e.preProcessDoc(document,globalThis,a);R(s,r),n&&t.processors.frameTree.cleanup(n),e.postProcessDoc(document,s.markedElements,s.invalidElements),a.userScriptEnabled&&o&&await o(e.ON_AFTER_CAPTURE_EVENT_NAME),l=!0,c=!1}}function S(){d&&a&&(a.autoSaveUnload||a.autoSaveLoadOrUnload||a.autoSaveDiscard||a.autoSaveRemove)?n||(globalThis.addEventListener("unload",w),document.addEventListener("visibilitychange",b),n=!0):(globalThis.removeEventListener("unload",w),document.removeEventListener("visibilitychange",b),n=!1)}function b(){"hidden"==document.visibilityState&&a.autoSaveDiscard&&T({autoSaveDiscard:a.autoSaveDiscard})}function w(){!l&&(a.autoSaveUnload||a.autoSaveLoadOrUnload||a.autoSaveRemove)&&T({autoSaveUnload:a.autoSaveUnload,autoSaveRemove:a.autoSaveRemove})}function T({autoSaveUnload:e,autoSaveDiscard:o,autoSaveRemove:n}){const r=t.helper,s=globalThis[r.WAIT_FOR_USERSCRIPT_PROPERTY_NAME];let d=[];!a.removeFrames&&globalThis.frames&&globalThis.frames.length&&(d=t.processors.frameTree.getSync(a)),a.userScriptEnabled&&s&&s(r.ON_BEFORE_CAPTURE_EVENT_NAME);R(r.preProcessDoc(document,globalThis,a),d,{autoSaveUnload:e,autoSaveDiscard:o,autoSaveRemove:n})}function R(e,o,{autoSaveUnload:n,autoSaveDiscard:d,autoSaveRemove:i}={}){const c=t.helper,l=t.pageInfo.updatedResources,u=t.pageInfo.visitDate.getTime();Object.keys(l).forEach((e=>l[e].retrieved=!1)),browser.runtime.sendMessage({method:"autosave.save",tabId:r,tabIndex:s,taskId:a.taskId,content:c.serialize(document),canvases:e.canvases,fonts:e.fonts,stylesheets:e.stylesheets,images:e.images,posters:e.posters,usedFonts:e.usedFonts,shadowRoots:e.shadowRoots,videos:e.videos,referrer:e.referrer,adoptedStyleSheets:e.adoptedStyleSheets,frames:o,url:location.href,updatedResources:l,visitDate:u,autoSaveUnload:n,autoSaveDiscard:d,autoSaveRemove:i})}async function I(){const t=await g();for(let o=0;o*e<t.length;o++){const n={method:"editor.open",filename:decodeURIComponent(location.href.match(/^.*\/(.*)$/)[1]),extractDataFromPageTags:h,insertTextBody:f,selfExtractingArchive:!0};n.truncated=t.length>e,n.truncated?(n.finished=(o+1)*e>t.length,t instanceof Uint8Array?n.content=Array.from(t.subarray(o*e,(o+1)*e)):n.content=t.substring(o*e,(o+1)*e)):(n.embeddedImage=await D(t),n.content=t instanceof Uint8Array?Array.from(t):t),await browser.runtime.sendMessage(n)}}async function D(e){if(137==e[0]&&80==e[1]&&78==e[2]&&71==e[3]){let t=new Blob([new Uint8Array(e)],{type:"image/png"});const o=URL.createObjectURL(t),n=new Image;n.src=o,await new Promise(((e,t)=>{n.onload=e,n.onerror=t}));const a=new OffscreenCanvas(n.width,n.height);a.getContext("2d").drawImage(n,0,0),t=await a.convertToBlob({type:"image/png"});const r=await t.arrayBuffer();return Array.from(new Uint8Array(r))}}function C(e){if(void 0===m){const o=t.helper,n=e.documentElement.firstChild;h=Boolean(e.querySelector("sfz-extra-data")),f=Boolean(e.querySelector("body > main[hidden]")),m=""==e.documentElement.dataset.sfz||n.nodeType==Node.COMMENT_NODE&&n.textContent.includes(o.COMMENT_HEADER)}return m}t.pageInfo={updatedResources:{},visitDate:new Date},browser.runtime.sendMessage({method:"bootstrap.init"}).then((e=>{a=e.optionsAutoSave;const t=e.options;r=e.tabId,s=e.tabIndex,d=e.autoSaveEnabled,t&&t.autoOpenEditor&&C(document)?"loading"==document.readyState?document.addEventListener("DOMContentLoaded",(()=>I())):I():"loading"==document.readyState?document.addEventListener("DOMContentLoaded",S):S()})),browser.runtime.onMessage.addListener((e=>{if(d&&"content.autosave"==e.method||"content.maybeInit"==e.method||"content.init"==e.method||"content.openEditor"==e.method||"devtools.resourceCommitted"==e.method||"singlefile.fetchResponse"==e.method)return p(e)})),document.addEventListener("DOMContentLoaded",y,!1),globalThis.window==globalThis.top&&location&&location.href&&(location.href.startsWith("file://")||location.href.startsWith("content://"))&&("loading"==document.readyState?document.addEventListener("DOMContentLoaded",v,!1):v())}();
