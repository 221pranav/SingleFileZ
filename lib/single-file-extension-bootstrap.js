!function(){"use strict";const t=8388608,n=0,e=[n],a=Symbol(),o=new TextEncoder,s=new TextDecoder,r=new Array(256);let i=0;function c(t,n,a,o){if(void 0===o){if(i++,!(r.length-i>=e.length))throw new Error("Reached maximum number of custom types");r[r.length-i]={serialize:t,parse:n,test:a}}else r[o]={serialize:t,parse:n,test:a}}c((async function(t,n){const e=t.objects.indexOf(n);await l(t,e)}),(async function(t){const n=await A(t);return new b(n,t)}),I,n),c(null,(function(){return{}}),D),c(w,S,N),c(m,O,(function(t){return"string"==typeof t})),c(y,(async function(t){const n=await A(t),e=await t.consume(8*n);return new Float64Array(e.buffer)}),(function(t){return t instanceof Float64Array})),c(y,(async function(t){const n=await A(t),e=await t.consume(4*n);return new Float32Array(e.buffer)}),(function(t){return t instanceof Float32Array})),c(y,(async function(t){const n=await A(t),e=await t.consume(4*n);return new Uint32Array(e.buffer)}),(function(t){return t instanceof Uint32Array})),c(y,(async function(t){const n=await A(t),e=await t.consume(4*n);return new Int32Array(e.buffer)}),(function(t){return t instanceof Int32Array})),c(y,(async function(t){const n=await A(t),e=await t.consume(2*n);return new Uint16Array(e.buffer)}),(function(t){return t instanceof Uint16Array})),c(y,(async function(t){const n=await A(t),e=await t.consume(2*n);return new Int16Array(e.buffer)}),(function(t){return t instanceof Int16Array})),c(y,(async function(t){const n=await A(t),e=await t.consume(n);return new Uint8ClampedArray(e.buffer)}),(function(t){return t instanceof Uint8ClampedArray})),c(y,(async function(t){const n=await A(t);return await t.consume(n)}),(function(t){return t instanceof Uint8Array})),c(y,(async function(t){const n=await A(t),e=await t.consume(n);return new Int8Array(e.buffer)}),(function(t){return t instanceof Int8Array})),c((async function(t,n){await l(t,n.byteLength),await t.append(new Uint8Array(n))}),(async function(t){const n=await A(t);return(await t.consume(n)).buffer}),(function(t){return t instanceof ArrayBuffer})),c(h,R,C),c((async function(t,n){const e=new Uint8Array(new Uint32Array([n]).buffer);await t.append(e)}),(async function(t){const n=await t.consume(4);return new Uint32Array(n.buffer)[0]}),(function(t){return M(t)&&t>=0&&t<=4294967295})),c((async function(t,n){const e=new Uint8Array(new Int32Array([n]).buffer);await t.append(e)}),(async function(t){const n=await t.consume(4);return new Int32Array(n.buffer)[0]}),(function(t){return M(t)&&t>=-2147483648&&t<=2147483647})),c((async function(t,n){const e=new Uint8Array(new Uint16Array([n]).buffer);await t.append(e)}),(async function(t){const n=await t.consume(2);return new Uint16Array(n.buffer)[0]}),(function(t){return M(t)&&t>=0&&t<=65535})),c((async function(t,n){const e=new Uint8Array(new Int16Array([n]).buffer);await t.append(e)}),(async function(t){const n=await t.consume(2);return new Int16Array(n.buffer)[0]}),(function(t){return M(t)&&t>=-32768&&t<=32767})),c((async function(t,n){const e=new Uint8Array([n]);await t.append(e)}),(async function(t){const n=await t.consume(1);return new Uint8Array(n.buffer)[0]}),(function(t){return M(t)&&t>=0&&t<=255})),c((async function(t,n){const e=new Uint8Array(new Int8Array([n]).buffer);await t.append(e)}),(async function(t){const n=await t.consume(1);return new Int8Array(n.buffer)[0]}),(function(t){return M(t)&&t>=-128&&t<=127})),c(null,(function(){return}),(function(t){return void 0===t})),c(null,(function(){return null}),(function(t){return null===t})),c(null,(function(){return NaN}),(function(t){return Number.isNaN(t)})),c(p,U,(function(t){return"boolean"==typeof t})),c((async function(t,n){await m(t,n.description)}),(async function(t){const n=await O(t);return Symbol(n)}),P),c(null,(function(){return a}),j),c((async function(t,n){const e=n.entries();await l(t,n.size);for(const[n,a]of e)await l(t,n),await l(t,a)}),(async function(t){const n=await A(t),e=new Map;n&&await async function a(o=0){const s=await A(t),r=await A(t);t.setObject([s,r],((t,n)=>e.set(t,n))),o<n-1&&await a(o+1)}();return e}),(function(t){return t instanceof Map})),c((async function(t,n){await l(t,n.size);for(const e of n)await l(t,e)}),(async function(t){const n=await A(t),e=new Set;n&&await async function a(o=0){const s=await A(t);t.setObject([s],(t=>e.add(t))),o<n-1&&await a(o+1)}();return e}),(function(t){return t instanceof Set})),c((async function(t,n){await h(t,n.getTime())}),(async function(t){const n=await R(t);return new Date(n)}),(function(t){return t instanceof Date})),c((async function(t,n){await m(t,n.message),await m(t,n.stack)}),(async function(t){const n=await O(t),e=await O(t),a=new Error(n);return a.stack=e,a}),(function(t){return t instanceof Error})),c((async function(t,n){await m(t,n.source),await m(t,n.flags)}),(async function(t){const n=await O(t),e=await O(t);return new RegExp(n,e)}),(function(t){return t instanceof RegExp})),c((async function(t,n){await m(t,n.valueOf())}),(async function(t){return new String(await O(t))}),(function(t){return t instanceof String})),c((async function(t,n){await h(t,n.valueOf())}),(async function(t){return new Number(await R(t))}),(function(t){return t instanceof Number})),c((async function(t,n){await p(t,n.valueOf())}),(async function(t){return new Boolean(await U(t))}),(function(t){return t instanceof Boolean}));class u{constructor(t,n){this.stream=new f(t,n),this.objects=[]}append(t){return this.stream.append(t)}flush(){return this.stream.flush()}addObject(t){this.objects.push(x(t)&&!I(t,this)?t:void 0)}}class f{constructor(t,n){this.offset=0,this.appendData=t,this.value=new Uint8Array(n)}async append(t){if(this.offset+t.length>this.value.length){const n=this.value.length-this.offset;await this.append(t.subarray(0,n)),await this.appendData({value:this.value}),this.offset=0,await this.append(t.subarray(n))}else this.value.set(t,this.offset),this.offset+=t.length}async flush(){this.offset&&await this.appendData({value:this.value.subarray(0,this.offset),done:!0})}}function d(n,{chunkSize:e=t}={}){let a,o,s,r,i,c;return{[Symbol.asyncIterator]:()=>({next:()=>r?{done:r}:async function(){c?c():f().catch((()=>{}));i=new Promise((t=>c=t));const t=await async function(){const{value:t,done:n}=await o;r=n,n||d();return t}();return{value:t}}(),return:()=>({done:!0})})};async function f(){d(),a=new u(w,e),await l(a,n),await a.flush()}function d(){o=new Promise((t=>s=t))}async function w(t){s(t),await i}}async function l(t,e){const a=r.findIndex((({test:n}={})=>n&&n(e,t)));t.addObject(e),await t.append(new Uint8Array([a]));const o=r[a].serialize;o&&await o(t,e),a!=n&&D(e)&&(await async function(t,n){const e=Object.getOwnPropertySymbols(n),a=e.map((t=>[t,n[t]]));await w(t,a)}(t,e),await async function(t,n){let e=Object.entries(n);N(n)&&(e=e.filter((([t])=>!M(Number(t)))));await l(t,e.length);for(const[n,a]of e)await m(t,n),await l(t,a)}(t,e))}async function w(t,n){await l(t,n.length);const e=Object.keys(n).filter((t=>M(Number(t)))).map((t=>Number(t)));let o=0,s=e[o];for(const[r,i]of n.entries())s==r?(s=e[++o],await l(t,i)):await l(t,a)}async function m(t,n){const e=o.encode(n);await l(t,e.length),await t.append(e)}async function y(t,n){await l(t,n.length),await t.append(new Uint8Array(n.buffer))}async function h(t,n){const e=new Uint8Array(new Float64Array([n]).buffer);await t.append(e)}async function p(t,n){const e=new Uint8Array([Number(n)]);await t.append(e)}class b{constructor(t,n){this.index=t,this.data=n}getObject(){return this.data.objects[this.index]}}class v{constructor(t){this.stream=new g(t),this.objects=[],this.setters=[]}consume(t){return this.stream.consume(t)}getObjectId(){const t=this.objects.length;return this.objects.push(void 0),t}resolveObject(t,n){x(n)&&!T(n)&&(this.objects[t]=n)}setObject(t,n){this.setters.push({functionArguments:t,setterFunction:n})}executeSetters(){this.setters.forEach((({functionArguments:t,setterFunction:n})=>{n(...t.map((t=>T(t)?t.getObject():t)))}))}}class g{constructor(t){this.offset=0,this.value=new Uint8Array(0),this.consumeData=t}async consume(t){if(this.offset+t>this.value.length){const n=this.value.subarray(this.offset,this.value.length),e=await this.consumeData();return n.length+e.length!=this.value.length&&(this.value=new Uint8Array(n.length+e.length)),this.value.set(n),this.value.set(e,n.length),this.offset=0,this.consume(t)}{const n=this.value.slice(this.offset,this.offset+t);return this.offset+=n.length,n}}}function E(){let t,n,e,a,o,s;return{next:async n=>n?async function(n){o?await o:async function(){let n;a=new Promise((t=>n=t)),t=new v(i),r();const e=await A(t);t.executeSetters(),n(e)}().catch((()=>{}));return function(){o=new Promise((t=>s=t))}(),e(n),{done:!1}}(n):{value:await a,done:!0},return:()=>({done:!0})};function r(){n=new Promise((t=>e=t))}async function i(){const t=await n;return r(),s&&s(),t}}async function A(t){const e=(await t.consume(1))[0],a=r[e].parse,o=t.getObjectId(),s=await a(t);return e!=n&&D(s)&&(await async function(t,n){const e=await S(t);t.setObject([e],(t=>t.forEach((([t,e])=>n[t]=e))))}(t,s),await async function(t,n){const e=await A(t);e&&await a();async function a(o=0){const s=await O(t),r=await A(t);t.setObject([r],(t=>n[s]=t)),o<e-1&&await a(o+1)}}(t,s)),t.resolveObject(o,s),s}async function S(t){const n=await A(t),e=new Array(n);return n&&await async function a(o=0){const s=await A(t);j(s)||t.setObject([s],(t=>e[o]=t));o<n-1&&await a(o+1)}(),e}async function O(t){const n=await A(t),e=await t.consume(n);return s.decode(e)}async function R(t){const n=await t.consume(8);return new Float64Array(n.buffer)[0]}async function U(t){const n=await t.consume(1);return Boolean(n[0])}function I(t,n){return D(t)&&n.objects.includes(t)}function T(t){return t instanceof b}function D(t){return t===Object(t)}function N(t){return"number"==typeof t.length}function j(t){return t===a}function C(t){return"number"==typeof t}function M(t){return C(t)&&Number.isInteger(t)}function P(t){return"symbol"==typeof t}function x(t){return D(t)||P(t)}const _=globalThis.singlefileBootstrap,F=[];let L,z,k,B,q,W,V,H,Y;async function G(){if(void 0!==document.documentElement.dataset.sfz){!function(t){const n=document.createElement("script");n.textContent="(() => { const bootstrapReady = this.bootstrap && this.bootstrap(["+new Uint8Array(t).toString()+']); if (bootstrapReady) { bootstrapReady.then(() => document.dispatchEvent(new CustomEvent("single-filez-display-infobar"))); } })()',document.body.appendChild(n)}(await X())}else if(document.body&&1==document.body.childNodes.length&&"PRE"==document.body.childNodes[0].tagName&&/<html[^>]* data-sfz[^>]*>/i.test(document.body.childNodes[0].textContent)){const t=(new DOMParser).parseFromString(document.body.childNodes[0].textContent,"text/html");document.replaceChild(t.documentElement,document.documentElement),document.querySelectorAll("script").forEach((t=>{const n=document.createElement("script");n.textContent=t.textContent,t.parentElement.replaceChild(n,t)})),await G()}}function X(){return new Promise(((t,n)=>{const e=new XMLHttpRequest;e.open("GET",location.href),e.send(),e.responseType="arraybuffer",e.onload=()=>t(new Uint8Array(e.response)),e.onerror=()=>{const e=E();e.test=new Date;const a=document.getElementById("sfz-error-message");a&&a.remove();const o=F.length;F.push({parser:e,resolve:t,reject:n}),browser.runtime.sendMessage({method:"singlefile.fetch",requestId:o,url:location.href})}}))}async function $(t){return q&&"content.autosave"==t.method?(async function(t){z=t.options,"complete"!=document.readyState&&await new Promise((t=>globalThis.addEventListener("load",t)));await K(),z.autoSaveRepeat&&setTimeout((()=>{q&&!V&&(H=!1,z.autoSaveDelay=0,$(t))}),1e3*z.autoSaveRepeatDelay)}(t),{}):"content.maybeInit"==t.method?(J(),{}):"content.init"==t.method?(z=t.options,q=t.autoSaveEnabled,Q(),{}):"content.openEditor"==t.method?(ot(document)?at():Q(),{}):"devtools.resourceCommitted"==t.method?(_.pageInfo.updatedResources[t.url]={content:t.content,type:t.type,encoding:t.encoding},{}):void("singlefile.fetchResponse"==t.method&&async function(t){if(F[t.requestId]){const{parser:n,resolve:e,reject:a}=F[t.requestId],o=await n.next(t.data);if(o.done){const t=o.value;t.error?a(new Error(t.error)):e(t.array)}}}(t))}function J(){const t=document.querySelector("singlefile-infobar");t&&t.remove(),Y==location.href||_.pageInfo.processing||(H=!1,Y=location.href,browser.runtime.sendMessage({method:"tabs.init",savedPageDetected:ot(document)}).catch((()=>{})),browser.runtime.sendMessage({method:"ui.processInit"}).catch((()=>{})))}async function K(){const t=_.helper;if((!V||W)&&!H)if(V=!0,z.autoSaveDelay&&!W)await new Promise((t=>W=setTimeout(t,1e3*z.autoSaveDelay))),await K();else{const n=window[t.WAIT_FOR_USERSCRIPT_PROPERTY_NAME];let e,a=[];W=null,!z.removeFrames&&globalThis.frames&&globalThis.frames.length&&(a=await _.processors.frameTree.getAsync(z)),e=a&&a.sessionId,z.userScriptEnabled&&n&&await n(t.ON_BEFORE_CAPTURE_EVENT_NAME);const o=t.preProcessDoc(document,globalThis,z);et(o,a),e&&_.processors.frameTree.cleanup(e),t.postProcessDoc(document,o.markedElements,o.invalidElements),z.userScriptEnabled&&n&&await n(t.ON_AFTER_CAPTURE_EVENT_NAME),H=!0,V=!1}}function Q(){q&&z&&(z.autoSaveUnload||z.autoSaveLoadOrUnload||z.autoSaveDiscard||z.autoSaveRemove)?L||(globalThis.addEventListener("unload",tt),document.addEventListener("visibilitychange",Z),L=!0):(globalThis.removeEventListener("unload",tt),document.removeEventListener("visibilitychange",Z),L=!1)}function Z(){"hidden"==document.visibilityState&&z.autoSaveDiscard&&nt({autoSaveDiscard:z.autoSaveDiscard})}function tt(){!H&&(z.autoSaveUnload||z.autoSaveLoadOrUnload||z.autoSaveRemove)&&nt({autoSaveUnload:z.autoSaveUnload,autoSaveRemove:z.autoSaveRemove})}function nt({autoSaveUnload:t,autoSaveDiscard:n,autoSaveRemove:e}){const a=_.helper,o=window[a.WAIT_FOR_USERSCRIPT_PROPERTY_NAME];let s=[];!z.removeFrames&&globalThis.frames&&globalThis.frames.length&&(s=_.processors.frameTree.getSync(z)),z.userScriptEnabled&&o&&o(a.ON_BEFORE_CAPTURE_EVENT_NAME);et(a.preProcessDoc(document,globalThis,z),s,{autoSaveUnload:t,autoSaveDiscard:n,autoSaveRemove:e})}function et(t,n,{autoSaveUnload:e,autoSaveDiscard:a,autoSaveRemove:o}={}){const s=_.helper,r=_.pageInfo.updatedResources,i=_.pageInfo.visitDate.getTime();Object.keys(r).forEach((t=>r[t].retrieved=!1)),browser.runtime.sendMessage({method:"autosave.save",tabId:k,tabIndex:B,taskId:z.taskId,content:s.serialize(document),canvases:t.canvases,fonts:t.fonts,stylesheets:t.stylesheets,images:t.images,posters:t.posters,usedFonts:t.usedFonts,shadowRoots:t.shadowRoots,videos:t.videos,referrer:t.referrer,adoptedStyleSheets:t.adoptedStyleSheets,frames:n,url:location.href,updatedResources:r,visitDate:i,autoSaveUnload:e,autoSaveDiscard:a,autoSaveRemove:o})}async function at(){const t=d({content:await X(),filename:decodeURIComponent(location.href.match(/^.*\/(.*)$/)[1])});for await(const n of t)await browser.runtime.sendMessage({method:"editor.open",data:Array.from(n)});await browser.runtime.sendMessage({method:"editor.open"})}function ot(t){const n=_.helper,e=t.documentElement.firstChild;return""==t.documentElement.dataset.sfz||e.nodeType==Node.COMMENT_NODE&&e.textContent.includes(n.COMMENT_HEADER)}_.pageInfo={updatedResources:{},visitDate:new Date},browser.runtime.sendMessage({method:"bootstrap.init"}).then((t=>{z=t.optionsAutoSave;const n=t.options;k=t.tabId,B=t.tabIndex,q=t.autoSaveEnabled,n&&n.autoOpenEditor&&ot(document)?"loading"==document.readyState?document.addEventListener("DOMContentLoaded",(()=>at())):at():"loading"==document.readyState?document.addEventListener("DOMContentLoaded",Q):Q()})),browser.runtime.onMessage.addListener((t=>{if(q&&"content.autosave"==t.method||"content.maybeInit"==t.method||"content.init"==t.method||"content.openEditor"==t.method||"devtools.resourceCommitted"==t.method||"singlefile.fetchResponse"==t.method)return $(t)})),document.addEventListener("DOMContentLoaded",J,!1),globalThis.window==globalThis.top&&location&&location.href&&(location.href.startsWith("file://")||location.href.startsWith("content://"))&&("loading"==document.readyState?document.addEventListener("DOMContentLoaded",G,!1):G())}();
