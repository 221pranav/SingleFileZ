!function(){"use strict";const n=8388608,t=0,e=[t],a=Symbol(),r=new TextEncoder,i=new TextDecoder,s=new Array(256);let o=0;function c(n,t,a,r){if(void 0===r){if(o++,!(s.length-o>=e.length))throw new Error("Reached maximum number of custom types");s[s.length-o]={serialize:n,parse:t,test:a}}else s[r]={serialize:n,parse:t,test:a}}c((async function(n,t){const e=n.objects.indexOf(t);await y(n,e)}),(async function(n){const t=await g(n);return new h(t,n)}),O,t),c(null,(function(){return{}}),j),c(l,A,M),c(d,I,(function(n){return"string"==typeof n})),c(m,(async function(n){const t=await g(n),e=await n.consume(8*t);return new Float64Array(e.buffer)}),(function(n){return n instanceof Float64Array})),c(m,(async function(n){const t=await g(n),e=await n.consume(4*t);return new Float32Array(e.buffer)}),(function(n){return n instanceof Float32Array})),c(m,(async function(n){const t=await g(n),e=await n.consume(4*t);return new Uint32Array(e.buffer)}),(function(n){return n instanceof Uint32Array})),c(m,(async function(n){const t=await g(n),e=await n.consume(4*t);return new Int32Array(e.buffer)}),(function(n){return n instanceof Int32Array})),c(m,(async function(n){const t=await g(n),e=await n.consume(2*t);return new Uint16Array(e.buffer)}),(function(n){return n instanceof Uint16Array})),c(m,(async function(n){const t=await g(n),e=await n.consume(2*t);return new Int16Array(e.buffer)}),(function(n){return n instanceof Int16Array})),c(m,(async function(n){const t=await g(n),e=await n.consume(t);return new Uint8ClampedArray(e.buffer)}),(function(n){return n instanceof Uint8ClampedArray})),c(m,(async function(n){const t=await g(n);return await n.consume(t)}),(function(n){return n instanceof Uint8Array})),c(m,(async function(n){const t=await g(n),e=await n.consume(t);return new Int8Array(e.buffer)}),(function(n){return n instanceof Int8Array})),c((async function(n,t){await y(n,t.byteLength),await n.append(new Uint8Array(t))}),(async function(n){const t=await g(n);return(await n.consume(t)).buffer}),(function(n){return n instanceof ArrayBuffer})),c(b,U,N),c((async function(n,t){const e=new Uint8Array(new Uint32Array([t]).buffer);await n.append(e)}),(async function(n){const t=await n.consume(4);return new Uint32Array(t.buffer)[0]}),(function(n){return R(n)&&n>=0&&n<=4294967295})),c((async function(n,t){const e=new Uint8Array(new Int32Array([t]).buffer);await n.append(e)}),(async function(n){const t=await n.consume(4);return new Int32Array(t.buffer)[0]}),(function(n){return R(n)&&n>=-2147483648&&n<=2147483647})),c((async function(n,t){const e=new Uint8Array(new Uint16Array([t]).buffer);await n.append(e)}),(async function(n){const t=await n.consume(2);return new Uint16Array(t.buffer)[0]}),(function(n){return R(n)&&n>=0&&n<=65535})),c((async function(n,t){const e=new Uint8Array(new Int16Array([t]).buffer);await n.append(e)}),(async function(n){const t=await n.consume(2);return new Int16Array(t.buffer)[0]}),(function(n){return R(n)&&n>=-32768&&n<=32767})),c((async function(n,t){const e=new Uint8Array([t]);await n.append(e)}),(async function(n){const t=await n.consume(1);return new Uint8Array(t.buffer)[0]}),(function(n){return R(n)&&n>=0&&n<=255})),c((async function(n,t){const e=new Uint8Array(new Int8Array([t]).buffer);await n.append(e)}),(async function(n){const t=await n.consume(1);return new Int8Array(t.buffer)[0]}),(function(n){return R(n)&&n>=-128&&n<=127})),c(null,(function(){return}),(function(n){return void 0===n})),c(null,(function(){return null}),(function(n){return null===n})),c(null,(function(){return NaN}),(function(n){return Number.isNaN(n)})),c(p,v,(function(n){return"boolean"==typeof n})),c((async function(n,t){await d(n,t.description)}),(async function(n){const t=await I(n);return Symbol(t)}),E),c(null,(function(){return a}),T),c((async function(n,t){const e=t.entries();await y(n,t.size);for(const[t,a]of e)await y(n,t),await y(n,a)}),(async function(n){const t=await g(n),e=new Map;t&&await async function a(r=0){const i=await g(n),s=await g(n);n.setObject([i,s],((n,t)=>e.set(n,t))),r<t-1&&await a(r+1)}();return e}),(function(n){return n instanceof Map})),c((async function(n,t){await y(n,t.size);for(const e of t)await y(n,e)}),(async function(n){const t=await g(n),e=new Set;t&&await async function a(r=0){const i=await g(n);n.setObject([i],(n=>e.add(n))),r<t-1&&await a(r+1)}();return e}),(function(n){return n instanceof Set})),c((async function(n,t){await b(n,t.getTime())}),(async function(n){const t=await U(n);return new Date(t)}),(function(n){return n instanceof Date})),c((async function(n,t){await d(n,t.message),await d(n,t.stack)}),(async function(n){const t=await I(n),e=await I(n),a=new Error(t);return a.stack=e,a}),(function(n){return n instanceof Error})),c((async function(n,t){await d(n,t.source),await d(n,t.flags)}),(async function(n){const t=await I(n),e=await I(n);return new RegExp(t,e)}),(function(n){return n instanceof RegExp})),c((async function(n,t){await d(n,t.valueOf())}),(async function(n){return new String(await I(n))}),(function(n){return n instanceof String})),c((async function(n,t){await b(n,t.valueOf())}),(async function(n){return new Number(await U(n))}),(function(n){return n instanceof Number})),c((async function(n,t){await p(n,t.valueOf())}),(async function(n){return new Boolean(await v(n))}),(function(n){return n instanceof Boolean}));class u{constructor(n,t){this.stream=new f(n,t),this.objects=[]}append(n){return this.stream.append(n)}flush(){return this.stream.flush()}addObject(n){this.objects.push(function(n){return j(n)||E(n)}(n)&&!O(n,this)?n:void 0)}}class f{constructor(n,t){this.offset=0,this.appendData=n,this.value=new Uint8Array(t)}async append(n){if(this.offset+n.length>this.value.length){const t=this.value.length-this.offset;await this.append(n.subarray(0,t)),await this.appendData({value:this.value}),this.offset=0,await this.append(n.subarray(t))}else this.value.set(n,this.offset),this.offset+=n.length}async flush(){this.offset&&await this.appendData({value:this.value.subarray(0,this.offset),done:!0})}}function w(t,{chunkSize:e=n}={}){let a,r,i,s,o,c;return{[Symbol.asyncIterator]:()=>({next:()=>s?{done:s}:async function(){c?c():f().catch((()=>{}));o=new Promise((n=>c=n));const n=await async function(){const{value:n,done:t}=await r;s=t,t||w();return n}();return{value:n}}(),return:()=>({done:!0})})};async function f(){w(),a=new u(l,e),await y(a,t),await a.flush()}function w(){r=new Promise((n=>i=n))}async function l(n){i(n),await o}}async function y(n,e){const a=s.findIndex((({test:t}={})=>t&&t(e,n)));n.addObject(e),await n.append(new Uint8Array([a]));const r=s[a].serialize;r&&await r(n,e),a!=t&&j(e)&&(await async function(n,t){const e=Object.getOwnPropertySymbols(t),a=e.map((n=>[n,t[n]]));await l(n,a)}(n,e),await async function(n,t){let e=Object.entries(t);M(t)&&(e=e.filter((([n])=>!R(Number(n)))));await y(n,e.length);for(const[t,a]of e)await d(n,t),await y(n,a)}(n,e))}async function l(n,t){await y(n,t.length);const e=Object.keys(t).filter((n=>R(Number(n)))).map((n=>Number(n)));let r=0,i=e[r];for(const[s,o]of t.entries())i==s?(i=e[++r],await y(n,o)):await y(n,a)}async function d(n,t){const e=r.encode(t);await y(n,e.length),await n.append(e)}async function m(n,t){await y(n,t.length),await n.append(new Uint8Array(t.buffer))}async function b(n,t){const e=new Uint8Array(new Float64Array([t]).buffer);await n.append(e)}async function p(n,t){const e=new Uint8Array([Number(t)]);await n.append(e)}class h{constructor(n,t){this.index=n,this.data=t}getObject(){return this.data.objects[this.index]}}async function g(n){const e=(await n.consume(1))[0],a=s[e].parse,r=n.getObjectId(),i=await a(n);return e!=t&&j(i)&&(await async function(n,t){const e=await A(n);n.setObject([e],(n=>n.forEach((([n,e])=>t[n]=e))))}(n,i),await async function(n,t){const e=await g(n);e&&await a();async function a(r=0){const i=await I(n),s=await g(n);n.setObject([s],(n=>t[i]=n)),r<e-1&&await a(r+1)}}(n,i)),n.resolveObject(r,i),i}async function A(n){const t=await g(n),e=new Array(t);return t&&await async function a(r=0){const i=await g(n);T(i)||n.setObject([i],(n=>e[r]=n));r<t-1&&await a(r+1)}(),e}async function I(n){const t=await g(n),e=await n.consume(t);return i.decode(e)}async function U(n){const t=await n.consume(8);return new Float64Array(t.buffer)[0]}async function v(n){const t=await n.consume(1);return Boolean(t[0])}function O(n,t){return j(n)&&t.objects.includes(n)}function j(n){return n===Object(n)}function M(n){return"number"==typeof n.length}function T(n){return n===a}function N(n){return"number"==typeof n}function R(n){return N(n)&&Number.isInteger(n)}function E(n){return"symbol"==typeof n}const S=new Map,x="x-single-file-request-id";async function q(n,t,e){const a=w({headers:e.headers,status:e.status,error:e.error,array:e.array});for await(const e of a)await browser.tabs.sendMessage(n,{method:"singlefile.fetchResponse",requestId:t,data:Array.from(e)});return await browser.tabs.sendMessage(n,{method:"singlefile.fetchResponse",requestId:t}),{}}function z(n,t={},e){return new Promise(((a,r)=>{const i=new XMLHttpRequest;if(i.withCredentials=!0,i.responseType="arraybuffer",i.onerror=n=>r(new Error(n.detail)),i.onreadystatechange=()=>{i.readyState==XMLHttpRequest.DONE&&(i.status||i.response.byteLength?401!=i.status&&403!=i.status&&404!=i.status||e?a({arrayBuffer:i.response,array:new Uint8Array(i.response),headers:{"content-type":i.getResponseHeader("Content-Type")},status:i.status}):z(n,t,!0).then(a).catch(r):r(new Error("Empty response")))},i.open("GET",n,!0),t.headers)for(const n of Object.entries(t.headers))i.setRequestHeader(n[0],n[1]);if(e){const n=String(Math.random()).substring(2);s=n,o=t.referrer,S.set(s,o),i.setRequestHeader(x,n)}var s,o;i.send()}))}browser.runtime.onMessage.addListener(((n,t)=>{if(n.method&&n.method.startsWith("singlefile.fetch"))return new Promise((e=>{(async function(n,t){if("singlefile.fetch"==n.method)try{const e=await z(n.url,{referrer:n.referrer,headers:n.headers});return q(t.tab.id,n.requestId,e)}catch(e){return q(t.tab.id,n.requestId,{error:e.message,arrray:[]})}else if("singlefile.fetchFrame"==n.method)return browser.tabs.sendMessage(t.tab.id,n)})(n,t).then(e).catch((n=>e({error:n&&n.toString()})))}))})),browser.runtime.onMessage.addListener(((n,t)=>{if("singlefile.frameTree.initResponse"==n.method||"singlefile.frameTree.ackInitRequest"==n.method)return browser.tabs.sendMessage(t.tab.id,n,{frameId:0}),Promise.resolve({})}));const L=new Map;function P(n,t){n.delete(t)}browser.runtime.onMessage.addListener(((n,t)=>{if("singlefile.lazyTimeout.setTimeout"==n.method){let e,a=L.get(t.tab.id);if(a)if(e=a.get(t.frameId),e){const t=e.get(n.type);t&&clearTimeout(t)}else e=new Map;const r=setTimeout((async()=>{try{const e=L.get(t.tab.id),a=e.get(t.frameId);e&&a&&P(a,n.type),await browser.tabs.sendMessage(t.tab.id,{method:"singlefile.lazyTimeout.onTimeout",type:n.type})}catch(n){}}),n.delay);return a||(a=new Map,e=new Map,a.set(t.frameId,e),L.set(t.tab.id,a)),e.set(n.type,r),Promise.resolve({})}if("singlefile.lazyTimeout.clearTimeout"==n.method){let e=L.get(t.tab.id);if(e){const a=e.get(t.frameId);if(a){const t=a.get(n.type);t&&clearTimeout(t),P(a,n.type)}}return Promise.resolve({})}})),browser.tabs.onRemoved.addListener((n=>L.delete(n)))}();
